set :user, "go"

set :local_path, "target"
set :deploy_artifact, "school-admin.zip"

set :staging_server, "twu-staging"
set :staging_deploy_path, "/var/opt/sukrupa/school-admin"

role :staging_server, "#{staging_server}"

namespace :staging do

    task :default, :roles => :staging_server do
        stop_remote_server      
        copy_deploy_artifact
        unzip_deploy_artifact
        start_remote_server
        recreate_database
        insert_fake_data
        safety_check
    end
    
    task :stop_remote_server, :roles => :staging_server do
        run "cd #{staging_deploy_path} && sh stop-server.sh"
    end    

    task :copy_deploy_artifact, :roles => :staging_server do
        run "rm -rf #{staging_deploy_path}"      
        run "mkdir -p #{staging_deploy_path}"
        upload "#{local_path}/#{deploy_artifact}", "#{staging_deploy_path}", :via => :scp
    end

    task :unzip_deploy_artifact, :roles => :staging_server do
        run "cd #{staging_deploy_path} && unzip -o #{deploy_artifact}"
    end

    task :start_remote_server, :roles => :staging_server do
        run "cd #{staging_deploy_path} && sh start-server.sh"
    end

    task :recreate_database, :roles => :staging_server do
        run "cd #{staging_deploy_path} && sh install/install-database.sh"
    end

    task :insert_fake_data, :roles => :staging_server do
        run "cd #{staging_deploy_path} && sh install/ant/bin/ant -Dresources.main.dir=install/dbdeploy -Dlib.main.dir=lib -Dsrc.sql.dir=install/dbdeploy/sql -Dsrc.sql.script.dir=install/dbdeploy/sql/script -Dsrc.sql.delta.dir=install/dbdeploy/sql/delta -Dops.deploy.insert.fake.data.sql=install/dbdeploy/sql/insert-fake-data.sql -Dops.deploy.delete.fake.data.sql=install/dbdeploy/sql/delete-fake-data.sql  -buildfile install/dbdeploy/build.xml db:insert-fake-data"
    end

    task :safety_check, :roles => :staging_server do
        times = 0;
        while times < 6
            wgetresult = system "wget --spider http://#{staging_server}:8080/students"
            if wgetresult
                break
            else
                times = times + 1
                sleep 10
            end
        end
        unless wgetresult
            fail "Could not contact webserver."
        end
    end

end
