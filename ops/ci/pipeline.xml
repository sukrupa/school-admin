<pipeline name="all">
  <trackingtool link="https://minglehosting.thoughtworks.com/sip/projects/sukrupa/cards/${ID}" regex="##(\d+)" />
  <materials>
    <git url="git@github.com:ThoughtWorksDonateNow2/sukrupa.git" />
  </materials>
  <stage name="build">
    <jobs>
      <job name="build">
        <tasks>
          <exec command="./build">
            <arg value="ci" />
          </exec>
        </tasks>
        <artifacts>
          <test src="target/reports" />
          <artifact src="target/school-admin.zip" dest="deploy" />
        </artifacts>
      </job>
    </jobs>
  </stage>
  <stage name="twist">
    <jobs>
      <job name="twist">
        <tasks>
          <exec command="./build">
            <arg value="test:twist" />
          </exec>
        </tasks>
        <tabs>
          <tab name="Twist" path="reports/html/index.html" />
        </tabs>
        <artifacts>
          <test src="target/reports" />
        </artifacts>
      </job>
    </jobs>
  </stage>
  <stage name="sonar">
    <jobs>
      <job name="sonar">
        <tasks>
          <exec command="./build">
            <arg value="cobertura:all" />
          </exec>
          <exec command="mvn">
            <arg value="--file" />
            <arg value="ops/sonar/pom.xml" />
            <arg value="sonar:sonar" />
          </exec>
        </tasks>
        <artifacts>
          <test src="target/reports/cobertura" />
        </artifacts>
      </job>
    </jobs>
  </stage>
  <stage name="deploy-development">
    <jobs>
      <job name="deploy-development">
        <tasks>
          <fetchartifact stage="build" job="build" srcfile="deploy/school-admin.zip" dest="target" />
          <exec command="cap" args="-f ops/deploy/capfile development deploy" />
        </tasks>
      </job>
    </jobs>
  </stage>
  <stage name="deploy-staging">
    <approval type="manual" />
    <jobs>
      <job name="deploy-staging">
        <tasks>
          <fetchartifact stage="build" job="build" srcfile="deploy/school-admin.zip" dest="target" />
          <exec command="cap" args="-f ops/deploy/capfile staging deploy" />
        </tasks>
      </job>
    </jobs>
  </stage>
  <stage name="deploy-production">
    <approval type="manual" />
    <jobs>
      <job name="deploy-production">
        <tasks>
          <fetchartifact stage="build" job="build" srcfile="deploy/school-admin.zip" dest="target" />
          <exec command="cap" args="-f ops/deploy/capfile production deploy" />
        </tasks>
      </job>
    </jobs>
  </stage>
</pipeline>
