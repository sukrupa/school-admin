<project name="twist">
    <import file="properties.xml" />
    <import file="macros.xml" />

    <target name="execute-twist">
        <delete file="${target.test.twist.failed.file}" />

        <exec executable="bash">
            <arg file="${ops.local.dir}/kill-firefox.sh"/>
        </exec>
        <echo message="Executing Twist tests from ${src.test.twist.fixtures.dir}."/>

        <taskdef classname="com.thoughtworks.twist.core.execution.ant.ExecuteScenariosTask"
                 classpathref="classpath.run.twist.scenarios"
                 name="twist.runner"/>

        <condition property="browser.executable"
                   value="C:/Program Files (x86)/Mozilla Firefox/Firefox.exe"
                   else="${module.dir}/ops/local/start-firefox.sh">
            <os family="windows"/>
        </condition>
        <copy file="src/twist.template.properties" toFile="src/twist.properties" overwrite="true">
            <filterset begintoken="@" endtoken="@">
                <filter token="BROWSER_EXECUTABLE" value="${browser.executable}"/>
                <filter token="FUNCTIONAL_TEST_DIRECTORY" value="${src.test.twist.fixtures.dir}"/>
            </filterset>
        </copy>

        <twist.runner
                scenarioDir="${src.test.twist.fixtures.dir}/scenarios"
                reportsDir="${target.reports.dir}"
                confDir="${twist-config}"
                failureproperty="twist.scenarios.failed"
                classpathref="classpath.run.twist.scenarios"
                tags="!in-progress">

            <fileset dir="${src.test.twist.fixtures.dir}/scenarios" includes="*"/>
        </twist.runner>

        <exec executable="bash">
            <arg file="${ops.local.dir}/kill-firefox.sh"/>
        </exec>

        <antcall target="report-status" />
    </target>

    <target name="report-status" if="twist.scenarios.failed">
        <propertyfile file="${target.test.twist.failed.file}">
            <entry key="twist.scenarios.failed" value="${twist.scenarios.failed}" />
        </propertyfile>
    </target>
</project>